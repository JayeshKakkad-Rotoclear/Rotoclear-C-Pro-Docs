<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategies - RotoClear Camera Server Documentation</title>
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><a href="/index.html">RotoClear Docs</a></h1>
                <p>Camera Server Documentation</p>
            </div>
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item depth-0">
<a href="/index.html">Home</a>
</li>
<li class="nav-item depth-0">
<a href="/getting-started.html">Getting Started</a>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Architecture</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/architecture/overview.html">Overview</a>
</li>
<li class="nav-item depth-1">
<a href="/architecture/state-management.html">State Management</a>
</li>
<li class="nav-item depth-1">
<a href="/architecture/camera-pipeline.html">Camera Pipeline</a>
</li>
<li class="nav-item depth-1">
<a href="/architecture/metadata-sqlite.html">Metadata & SQLite</a>
</li>
<li class="nav-folder depth-1">
<span class="folder-title">Decisions</span>
<ul class="nav-submenu">
<li class="nav-item depth-2">
<a href="/architecture/decisions/ADR-0001-nim-language.html">ADR-0001 Nim Language</a>
</li>
<li class="nav-item depth-2">
<a href="/architecture/decisions/ADR-0002-corun-framework.html">ADR-0002 Corun Framework</a>
</li>
<li class="nav-item depth-2">
<a href="/architecture/decisions/ADR-0003-observable-state.html">ADR-0003 Observable State</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">API Reference</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/api/README.html">Overview</a>
</li>
<li class="nav-item depth-1">
<a href="/api/websocket-api.html">WebSocket API</a>
</li>
<li class="nav-item depth-1">
<a href="/api/http-api.html">HTTP API</a>
</li>
<li class="nav-item depth-1">
<a href="/api/rtsp-streaming.html">RTSP Streaming</a>
</li>
<li class="nav-folder depth-1">
<span class="folder-title">Examples</span>
<ul class="nav-submenu">
<li class="nav-item depth-2">
<a href="/api/examples/python-client.html">Python Client</a>
</li>
<li class="nav-item depth-2">
<a href="/api/examples/javascript-client.html">JavaScript Client</a>
</li>
<li class="nav-item depth-2">
<a href="/api/examples/csharp-client.html">C# Client</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Configuration</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/configuration/environments.html">Environments</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/factory-config.html">Factory Config</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/license-config.html">License Config</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/deployment-variants.html">Deployment Variants</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/camera-system.html">Camera System</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/network.html">Network</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/storage-backup.html">Storage & Backup</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/authentication.html">Authentication</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Camera System</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/camera/hardware-interface.html">Hardware Interface</a>
</li>
<li class="nav-item depth-1">
<a href="/camera/streaming.html">Streaming</a>
</li>
<li class="nav-item depth-1">
<a href="/camera/recording.html">Recording</a>
</li>
<li class="nav-item depth-1">
<a href="/camera/image-processing.html">Image Processing</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Operations</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/operations/build-and-deploy.html">Build and Deploy</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/build-deploy.html">Build & Deploy (Alt)</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/monitoring.html">Monitoring</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/performance.html">Performance</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/troubleshooting.html">Troubleshooting</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Security</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/security/authentication.html">Authentication</a>
</li>
<li class="nav-item depth-1">
<a href="/security/permissions.html">Permissions</a>
</li>
<li class="nav-item depth-1">
<a href="/security/ssl-certificates.html">SSL Certificates</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Testing</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/testing/testing-strategy.html">Strategy</a>
</li>
<li class="nav-item depth-1 active">
<a href="/testing/strategies.html">Strategies</a>
</li>
<li class="nav-item depth-1">
<a href="/testing/test-cases.html">Test Cases</a>
</li>
<li class="nav-item depth-1">
<a href="/testing/validation.html">Validation</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Integration</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/integration/onvif-protocol.html">ONVIF Protocol</a>
</li>
<li class="nav-item depth-1">
<a href="/integration/third-party.html">Third Party</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Reference</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/reference/glossary.html">Glossary</a>
</li>
<li class="nav-item depth-1">
<a href="/reference/requirements.html">Requirements</a>
</li>
<li class="nav-item depth-1">
<a href="/reference/state-observables.html">State Observables</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Releases</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/releases/CHANGELOG.html">Changelog</a>
</li>
</ul>
</li>
<li class="nav-item depth-0">
<a href="/glossary.html">Glossary</a>
</li>
                </ul>
            </nav>
        </aside>
        
        <main class="content">
            <div class="content-wrapper">
                <h1 id="testing-strategies">Testing Strategies</h1>
<p><strong>Comprehensive testing methodologies and frameworks for C Pro system validation, quality assurance, and continuous integration.</strong></p>
<h2 id="overview">Overview</h2>
<p>The C Pro testing strategy ensures system reliability, performance, and quality through multiple testing layers including unit tests, integration tests, system tests, and continuous validation.</p>
<div class="mermaid">
graph TB
    A[Testing Strategy] --> B{Testing Levels}

    B -->|Code Level| C[Unit Testing]
    B -->|Component Level| D[Integration Testing]
    B -->|System Level| E[System Testing]
    B -->|User Level| F[Acceptance Testing]

    C --> C1[Function Tests]
    C --> C2[Module Tests]
    C --> C3[Class Tests]
    C --> C4[API Tests]

    D --> D1[Component Integration]
    D --> D2[Service Integration]
    D --> D3[Database Integration]
    D --> D4[External API Integration]

    E --> E1[Performance Testing]
    E --> E2[Security Testing]
    E --> E3[Compatibility Testing]
    E --> E4[Reliability Testing]

    F --> F1[User Acceptance]
    F --> F2[Business Acceptance]
    F --> F3[Operational Acceptance]
    F --> F4[Contract Acceptance]
</div>

<h2 id="testing-framework-architecture">Testing Framework Architecture</h2>
<h3 id="test-environment-setup">Test Environment Setup</h3>
<p><strong>Docker Test Environment</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># Dockerfile.test</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">nim:1.6.14-alpine</span>

<span class="c"># Install test dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>gcc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>musl-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>linux-headers<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>gstreamer-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>gstreamer-plugins-base-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>v4l-utils-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ffmpeg-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>sqlite-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>postgresql-dev

<span class="c"># Install Nim testing framework</span>
<span class="k">RUN</span><span class="w"> </span>nimble<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>unittest2<span class="w"> </span><span class="nb">times</span><span class="w"> </span>asynctest<span class="w"> </span>mock

<span class="c"># Copy source code</span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>/app
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># Install project dependencies</span>
<span class="k">RUN</span><span class="w"> </span>nimble<span class="w"> </span>install<span class="w"> </span>-d

<span class="c"># Run tests</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;nimble&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
</code></pre></div>

<p><strong>Test Configuration</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/config.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="n">strutils</span>

<span class="k">const</span>
<span class="w">  </span><span class="n">TEST_DATA_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tests/data&quot;</span>
<span class="w">  </span><span class="n">TEST_OUTPUT_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tests/output&quot;</span>
<span class="w">  </span><span class="n">TEST_DATABASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tests/test.db&quot;</span>
<span class="w">  </span><span class="n">TEST_CONFIG_FILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tests/test_config.json&quot;</span>

<span class="k">type</span>
<span class="w">  </span><span class="n">TestEnvironment</span><span class="o">*</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">object</span>
<span class="w">    </span><span class="n">dataDir</span><span class="o">*</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span>
<span class="w">    </span><span class="n">outputDir</span><span class="o">*</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span>
<span class="w">    </span><span class="n">database</span><span class="o">*</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span>
<span class="w">    </span><span class="n">configFile</span><span class="o">*</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span>
<span class="w">    </span><span class="n">cleanup</span><span class="o">*</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span>

<span class="k">proc</span><span class="w"> </span><span class="nf">setupTestEnvironment</span><span class="o">*</span><span class="p">():</span><span class="w"> </span><span class="n">TestEnvironment</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="sd">## Setup test environment</span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestEnvironment</span><span class="p">(</span>
<span class="w">    </span><span class="n">dataDir</span><span class="p">:</span><span class="w"> </span><span class="n">TEST_DATA_DIR</span><span class="p">,</span>
<span class="w">    </span><span class="n">outputDir</span><span class="p">:</span><span class="w"> </span><span class="n">TEST_OUTPUT_DIR</span><span class="p">,</span>
<span class="w">    </span><span class="n">database</span><span class="p">:</span><span class="w"> </span><span class="n">TEST_DATABASE</span><span class="p">,</span>
<span class="w">    </span><span class="n">configFile</span><span class="p">:</span><span class="w"> </span><span class="n">TEST_CONFIG_FILE</span><span class="p">,</span>
<span class="w">    </span><span class="n">cleanup</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Create test directories</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">dirExists</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">dataDir</span><span class="p">):</span>
<span class="w">    </span><span class="n">createDir</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">dataDir</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">dirExists</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">outputDir</span><span class="p">):</span>
<span class="w">    </span><span class="n">createDir</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">outputDir</span><span class="p">)</span>

<span class="k">proc</span><span class="w"> </span><span class="nf">cleanupTestEnvironment</span><span class="o">*</span><span class="p">(</span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="sd">## Cleanup test environment</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">cleanup</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">fileExists</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">database</span><span class="p">):</span>
<span class="w">      </span><span class="n">removeFile</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">database</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">dirExists</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">outputDir</span><span class="p">):</span>
<span class="w">      </span><span class="n">removeDir</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">outputDir</span><span class="p">)</span>
</code></pre></div>

<h3 id="test-suite-organization">Test Suite Organization</h3>
<p><strong>Test Directory Structure</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">tests</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="n">unit</span><span class="o">/</span><span class="w">                    </span><span class="err">#</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="n">tests</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_camera</span><span class="o">.</span><span class="n">nim</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_settings</span><span class="o">.</span><span class="n">nim</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_helpers</span><span class="o">.</span><span class="n">nim</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">test_state</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="n">integration</span><span class="o">/</span><span class="w">             </span><span class="err">#</span><span class="w"> </span><span class="n">Integration</span><span class="w"> </span><span class="n">tests</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_api</span><span class="o">.</span><span class="n">nim</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_websocket</span><span class="o">.</span><span class="n">nim</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_onvif</span><span class="o">.</span><span class="n">nim</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">test_database</span><span class="o">.</span><span class="n">nim</span>
<span class="err">├──</span><span class="w"> </span><span class="n">system</span><span class="o">/</span><span class="w">                  </span><span class="err">#</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">tests</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_streaming</span><span class="o">.</span><span class="n">nim</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_recording</span><span class="o">.</span><span class="n">nim</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">test_performance</span><span class="o">.</span><span class="n">nim</span>
<span class="err">├──</span><span class="w"> </span><span class="n">acceptance</span><span class="o">/</span><span class="w">              </span><span class="err">#</span><span class="w"> </span><span class="n">Acceptance</span><span class="w"> </span><span class="n">tests</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_user_scenarios</span><span class="o">.</span><span class="n">nim</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">test_business_rules</span><span class="o">.</span><span class="n">nim</span>
<span class="err">├──</span><span class="w"> </span><span class="n">data</span><span class="o">/</span><span class="w">                    </span><span class="err">#</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">data</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_images</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">test_videos</span><span class="o">/</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">test_configs</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="n">fixtures</span><span class="o">/</span><span class="w">                </span><span class="err">#</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">fixtures</span>
<span class="err">├──</span><span class="w"> </span><span class="n">mocks</span><span class="o">/</span><span class="w">                   </span><span class="err">#</span><span class="w"> </span><span class="n">Mock</span><span class="w"> </span><span class="n">objects</span>
<span class="err">└──</span><span class="w"> </span><span class="n">utils</span><span class="o">/</span><span class="w">                   </span><span class="err">#</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">utilities</span>
</code></pre></div>

<h2 id="unit-testing">Unit Testing</h2>
<h3 id="camera-module-testing">Camera Module Testing</h3>
<p><strong>Camera Unit Tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/unit/test_camera.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">asynctest</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">camserver</span><span class="o">/</span><span class="n">cam</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">config</span>

<span class="n">suite</span><span class="w"> </span><span class="s">&quot;Camera Module Tests&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span>

<span class="w">  </span><span class="n">setup</span><span class="p">:</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setupTestEnvironment</span><span class="p">()</span>

<span class="w">  </span><span class="n">teardown</span><span class="p">:</span>
<span class="w">    </span><span class="n">cleanupTestEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Camera initialization&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCamera</span><span class="p">()</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kp">nil</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CameraStatus</span><span class="p">.</span><span class="n">Disconnected</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Camera configuration&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCamera</span><span class="p">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CameraConfig</span><span class="p">(</span>
<span class="w">      </span><span class="n">devicePath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/dev/video0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">resolution</span><span class="p">:</span><span class="w"> </span><span class="n">Resolution</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="mi">1920</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="mi">1080</span><span class="p">),</span>
<span class="w">      </span><span class="n">framerate</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span>
<span class="w">      </span><span class="n">format</span><span class="p">:</span><span class="w"> </span><span class="n">VideoFormat</span><span class="p">.</span><span class="n">H264</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">camera</span><span class="p">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">resolution</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1920</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">framerate</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">30</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Camera streaming&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCamera</span><span class="p">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CameraConfig</span><span class="p">(</span>
<span class="w">      </span><span class="n">devicePath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/dev/video0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">resolution</span><span class="p">:</span><span class="w"> </span><span class="n">Resolution</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="mi">1280</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="mi">720</span><span class="p">),</span>
<span class="w">      </span><span class="n">framerate</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">camera</span><span class="p">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CameraStatus</span><span class="p">.</span><span class="n">Streaming</span>

<span class="w">    </span><span class="c"># Test frame capture</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">captureFrame</span><span class="p">()</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kp">nil</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CameraStatus</span><span class="p">.</span><span class="n">Stopped</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Camera error handling&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCamera</span><span class="p">()</span>

<span class="w">    </span><span class="n">expect</span><span class="p">(</span><span class="n">CameraError</span><span class="p">):</span>
<span class="w">      </span><span class="n">camera</span><span class="p">.</span><span class="n">configure</span><span class="p">(</span><span class="n">CameraConfig</span><span class="p">(</span><span class="n">devicePath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/invalid/path&quot;</span><span class="p">))</span>

<span class="w">    </span><span class="n">expect</span><span class="p">(</span><span class="n">CameraError</span><span class="p">):</span>
<span class="w">      </span><span class="k">discard</span><span class="w"> </span><span class="n">waitFor</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">start</span><span class="p">()</span><span class="w">  </span><span class="c"># Should fail without config</span>
</code></pre></div>

<h3 id="settings-module-testing">Settings Module Testing</h3>
<p><strong>Settings Unit Tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/unit/test_settings.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">json</span><span class="p">,</span><span class="w"> </span><span class="n">os</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">settings</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">config</span>

<span class="n">suite</span><span class="w"> </span><span class="s">&quot;Settings Module Tests&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span>

<span class="w">  </span><span class="n">setup</span><span class="p">:</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setupTestEnvironment</span><span class="p">()</span>

<span class="w">  </span><span class="n">teardown</span><span class="p">:</span>
<span class="w">    </span><span class="n">cleanupTestEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Default settings loading&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadDefaultSettings</span><span class="p">()</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kp">nil</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">resolution</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">network</span><span class="p">.</span><span class="n">httpPort</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Settings file loading&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Create test settings file</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">testSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;camera&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;resolution&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1920</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;height&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1080</span><span class="p">},</span>
<span class="w">        </span><span class="s">&quot;framerate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s">&quot;network&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;httpPort&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8080</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;rtspPort&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">554</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">writeFile</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">configFile</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">testSettings</span><span class="p">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadSettingsFromFile</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">configFile</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">resolution</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1920</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">network</span><span class="p">.</span><span class="n">httpPort</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8080</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Settings validation&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Settings</span><span class="p">()</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">resolution</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w">  </span><span class="c"># Invalid</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validateSettings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">validation</span><span class="p">.</span><span class="n">valid</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">validation</span><span class="p">.</span><span class="n">errors</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Settings persistence&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">originalSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadDefaultSettings</span><span class="p">()</span>
<span class="w">    </span><span class="n">originalSettings</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">resolution</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1920</span>
<span class="w">    </span><span class="n">originalSettings</span><span class="p">.</span><span class="n">network</span><span class="p">.</span><span class="n">httpPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9090</span>

<span class="w">    </span><span class="n">saveSettingsToFile</span><span class="p">(</span><span class="n">originalSettings</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">configFile</span><span class="p">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">loadedSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadSettingsFromFile</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">configFile</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">loadedSettings</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">resolution</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1920</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">loadedSettings</span><span class="p">.</span><span class="n">network</span><span class="p">.</span><span class="n">httpPort</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">9090</span>
</code></pre></div>

<h3 id="state-management-testing">State Management Testing</h3>
<p><strong>Observable State Tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/unit/test_state/test_observable.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">asynctest</span><span class="p">,</span><span class="w"> </span><span class="n">json</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">state</span><span class="o">/</span><span class="n">observable</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">config</span>

<span class="n">suite</span><span class="w"> </span><span class="s">&quot;Observable State Tests&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span>

<span class="w">  </span><span class="n">setup</span><span class="p">:</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setupTestEnvironment</span><span class="p">()</span>

<span class="w">  </span><span class="n">teardown</span><span class="p">:</span>
<span class="w">    </span><span class="n">cleanupTestEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;State creation and initialization&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newObservableState</span><span class="o">[</span><span class="n">CameraState</span><span class="o">]</span><span class="p">()</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kp">nil</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">observers</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Observer registration&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newObservableState</span><span class="o">[</span><span class="n">CameraState</span><span class="o">]</span><span class="p">()</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">notificationReceived</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">false</span>

<span class="w">    </span><span class="k">proc</span><span class="w"> </span><span class="nf">observer</span><span class="p">(</span><span class="n">oldState</span><span class="p">,</span><span class="w"> </span><span class="n">newState</span><span class="p">:</span><span class="w"> </span><span class="n">CameraState</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">notificationReceived</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>

<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">observers</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;State update notification&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newObservableState</span><span class="o">[</span><span class="n">CameraState</span><span class="o">]</span><span class="p">()</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">notifications</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">lastState</span><span class="p">:</span><span class="w"> </span><span class="n">CameraState</span>

<span class="w">    </span><span class="k">proc</span><span class="w"> </span><span class="nf">observer</span><span class="p">(</span><span class="n">oldState</span><span class="p">,</span><span class="w"> </span><span class="n">newState</span><span class="p">:</span><span class="w"> </span><span class="n">CameraState</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">notifications</span><span class="p">.</span><span class="n">inc</span>
<span class="w">      </span><span class="n">lastState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newState</span>

<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">newState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CameraState</span><span class="p">(</span>
<span class="w">      </span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="n">CameraStatus</span><span class="p">.</span><span class="n">Streaming</span><span class="p">,</span>
<span class="w">      </span><span class="n">resolution</span><span class="p">:</span><span class="w"> </span><span class="n">Resolution</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="mi">1920</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="mi">1080</span><span class="p">),</span>
<span class="w">      </span><span class="n">framerate</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">newState</span><span class="p">)</span>

<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">notifications</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">lastState</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CameraStatus</span><span class="p">.</span><span class="n">Streaming</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Multiple observers&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newObservableState</span><span class="o">[</span><span class="n">CameraState</span><span class="o">]</span><span class="p">()</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">observer1Called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">false</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">observer2Called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">false</span>

<span class="w">    </span><span class="k">proc</span><span class="w"> </span><span class="nf">observer1</span><span class="p">(</span><span class="n">oldState</span><span class="p">,</span><span class="w"> </span><span class="n">newState</span><span class="p">:</span><span class="w"> </span><span class="n">CameraState</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">observer1Called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>

<span class="w">    </span><span class="k">proc</span><span class="w"> </span><span class="nf">observer2</span><span class="p">(</span><span class="n">oldState</span><span class="p">,</span><span class="w"> </span><span class="n">newState</span><span class="p">:</span><span class="w"> </span><span class="n">CameraState</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">observer2Called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>

<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">observer1</span><span class="p">)</span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">observer2</span><span class="p">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">newState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CameraState</span><span class="p">(</span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="n">CameraStatus</span><span class="p">.</span><span class="n">Recording</span><span class="p">)</span>
<span class="w">    </span><span class="n">waitFor</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">newState</span><span class="p">)</span>

<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">observer1Called</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">observer2Called</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Observer removal&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newObservableState</span><span class="o">[</span><span class="n">CameraState</span><span class="o">]</span><span class="p">()</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">notificationCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="k">proc</span><span class="w"> </span><span class="nf">observer</span><span class="p">(</span><span class="n">oldState</span><span class="p">,</span><span class="w"> </span><span class="n">newState</span><span class="p">:</span><span class="w"> </span><span class="n">CameraState</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">notificationCount</span><span class="p">.</span><span class="n">inc</span>

<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">removeObserver</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>

<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">observers</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">newState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CameraState</span><span class="p">(</span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="n">CameraStatus</span><span class="p">.</span><span class="n">Streaming</span><span class="p">)</span>
<span class="w">    </span><span class="n">waitFor</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">newState</span><span class="p">)</span>

<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">notificationCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>

<h2 id="integration-testing">Integration Testing</h2>
<h3 id="api-integration-tests">API Integration Tests</h3>
<p><strong>HTTP API Tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/integration/test_api.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">asynctest</span><span class="p">,</span><span class="w"> </span><span class="n">httpclient</span><span class="p">,</span><span class="w"> </span><span class="n">json</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">servers</span><span class="o">/</span><span class="n">httpapi</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">config</span>

<span class="n">suite</span><span class="w"> </span><span class="s">&quot;HTTP API Integration Tests&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="kd">var</span>
<span class="w">    </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span>
<span class="w">    </span><span class="n">server</span><span class="p">:</span><span class="w"> </span><span class="n">HttpServer</span>
<span class="w">    </span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">AsyncHttpClient</span>

<span class="w">  </span><span class="n">setup</span><span class="p">:</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setupTestEnvironment</span><span class="p">()</span>
<span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newHttpServer</span><span class="p">()</span>
<span class="w">    </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAsyncHttpClient</span><span class="p">()</span>

<span class="w">    </span><span class="c"># Start test server</span>
<span class="w">    </span><span class="n">asyncSpawn</span><span class="w"> </span><span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">8081</span><span class="p">)</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">sleepAsync</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">  </span><span class="c"># Wait for server to start</span>

<span class="w">  </span><span class="n">teardown</span><span class="p">:</span>
<span class="w">    </span><span class="n">cleanupTestEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="w">    </span><span class="n">server</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;GET /api/status&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8081/api/status&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">responseData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">await</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">responseData</span><span class="p">.</span><span class="n">hasKey</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">responseData</span><span class="p">.</span><span class="n">hasKey</span><span class="p">(</span><span class="s">&quot;timestamp&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;GET /api/camera/info&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8081/api/camera/info&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">cameraInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">await</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">cameraInfo</span><span class="p">.</span><span class="n">hasKey</span><span class="p">(</span><span class="s">&quot;device&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">cameraInfo</span><span class="p">.</span><span class="n">hasKey</span><span class="p">(</span><span class="s">&quot;capabilities&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">cameraInfo</span><span class="p">.</span><span class="n">hasKey</span><span class="p">(</span><span class="s">&quot;current_settings&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;PUT /api/camera/settings&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;resolution&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1280</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;height&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">720</span><span class="p">},</span>
<span class="w">      </span><span class="s">&quot;framerate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;quality&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">put</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;http://127.0.0.1:8081/api/camera/settings&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">settings</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="c"># Verify settings were applied</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">getResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8081/api/camera/settings&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">appliedSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">await</span><span class="w"> </span><span class="n">getResponse</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">appliedSettings</span><span class="o">[</span><span class="s">&quot;resolution&quot;</span><span class="o">][</span><span class="s">&quot;width&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1280</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;POST /api/camera/snapshot&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8081/api/camera/snapshot&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">contentType</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&quot;image/&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">imageData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">body</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">imageData</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;API authentication&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Test without auth token</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">unauthedResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8081/api/admin/users&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">unauthedResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http401</span>

<span class="w">    </span><span class="c"># Test with invalid token</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newHttpHeaders</span><span class="p">({</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Bearer invalid_token&quot;</span><span class="p">})</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">invalidResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8081/api/admin/users&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">invalidResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http401</span>

<span class="w">    </span><span class="c"># Test with valid token</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newHttpHeaders</span><span class="p">({</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Bearer valid_test_token&quot;</span><span class="p">})</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">validResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8081/api/admin/users&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">validResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>
</code></pre></div>

<h3 id="websocket-integration-tests">WebSocket Integration Tests</h3>
<p><strong>WebSocket API Tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/integration/test_websocket.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">asynctest</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="n">json</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">servers</span><span class="o">/</span><span class="n">websocketApiV1Handler</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">config</span>

<span class="n">suite</span><span class="w"> </span><span class="s">&quot;WebSocket Integration Tests&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="kd">var</span>
<span class="w">    </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span>
<span class="w">    </span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">WebSocket</span>

<span class="w">  </span><span class="n">setup</span><span class="p">:</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setupTestEnvironment</span><span class="p">()</span>
<span class="w">    </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitFor</span><span class="w"> </span><span class="n">newWebSocket</span><span class="p">(</span><span class="s">&quot;ws://127.0.0.1:8080/api/v1/ws&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="n">teardown</span><span class="p">:</span>
<span class="w">    </span><span class="n">cleanupTestEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kp">nil</span><span class="p">:</span>
<span class="w">      </span><span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;WebSocket connection&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">readyState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Open</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Status subscription&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Subscribe to status updates</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">subscribeMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;subscribe&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;channel&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;test_subscription&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">$</span><span class="n">subscribeMsg</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Wait for subscription confirmation</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">receiveStrPacket</span><span class="p">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">responseData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">responseData</span><span class="o">[</span><span class="s">&quot;type&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;subscription_confirmed&quot;</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">responseData</span><span class="o">[</span><span class="s">&quot;channel&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;status&quot;</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Camera control via WebSocket&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Send camera start command</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">startCmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;command&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;camera_start&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;resolution&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1280</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;height&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">720</span><span class="p">},</span>
<span class="w">        </span><span class="s">&quot;framerate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;start_command&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">$</span><span class="n">startCmd</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Wait for command response</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">receiveStrPacket</span><span class="p">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">responseData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">responseData</span><span class="o">[</span><span class="s">&quot;type&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;command_response&quot;</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">responseData</span><span class="o">[</span><span class="s">&quot;id&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;start_command&quot;</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">responseData</span><span class="o">[</span><span class="s">&quot;success&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getBool</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kp">true</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Real-time status updates&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Subscribe to status updates</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">subscribeMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;subscribe&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;channel&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;status&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">$</span><span class="n">subscribeMsg</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Skip subscription confirmation</span>
<span class="w">    </span><span class="k">discard</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">receiveStrPacket</span><span class="p">()</span>

<span class="w">    </span><span class="c"># Trigger status change (mock)</span>
<span class="w">    </span><span class="c"># In real test, this would be triggered by actual camera state change</span>

<span class="w">    </span><span class="c"># Wait for status update</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">statusUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">receiveStrPacket</span><span class="p">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">updateData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">statusUpdate</span><span class="p">)</span>

<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">updateData</span><span class="o">[</span><span class="s">&quot;type&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;status_update&quot;</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">updateData</span><span class="p">.</span><span class="n">hasKey</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="database-integration-tests">Database Integration Tests</h3>
<p><strong>Database Tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/integration/test_database.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">asynctest</span><span class="p">,</span><span class="w"> </span><span class="n">db_sqlite</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">database</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">config</span>

<span class="n">suite</span><span class="w"> </span><span class="s">&quot;Database Integration Tests&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="kd">var</span>
<span class="w">    </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span>
<span class="w">    </span><span class="n">db</span><span class="p">:</span><span class="w"> </span><span class="n">DbConn</span>

<span class="w">  </span><span class="n">setup</span><span class="p">:</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setupTestEnvironment</span><span class="p">()</span>
<span class="w">    </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">database</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">initializeDatabase</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="w">  </span><span class="n">teardown</span><span class="p">:</span>
<span class="w">    </span><span class="n">db</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="w">    </span><span class="n">cleanupTestEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Database schema creation&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Check if tables exist</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">getAllRows</span><span class="p">(</span><span class="s">sql&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">tableNames</span><span class="p">:</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="nb">string</span><span class="o">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tables</span><span class="p">:</span>
<span class="w">      </span><span class="n">tableNames</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>

<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="s">&quot;users&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tableNames</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="s">&quot;camera_settings&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tableNames</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="s">&quot;recordings&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tableNames</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="s">&quot;events&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tableNames</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;User CRUD operations&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Create user</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">insertID</span><span class="p">(</span><span class="s">sql&quot;</span><span class="se">&quot;&quot;</span>
<span class="w">      </span><span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">password_hash</span><span class="p">,</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="p">)</span>
<span class="w">      </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="n">datetime</span><span class="p">(</span><span class="sc">&#39;now&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="s2">&quot;&quot;&quot;</span><span class="s">, &quot;testuser&quot;, &quot;test@example.com&quot;, &quot;hashed_password&quot;, &quot;operator&quot;)</span>

<span class="s">    check userId &gt; 0</span>

<span class="s">    # Read user</span>
<span class="s">    let user = db.getRow(sql&quot;SELECT * FROM users WHERE id = ?&quot;, userId)</span>
<span class="s">    check user[1] == &quot;testuser&quot;</span>
<span class="s">    check user[2] == &quot;test@example.com&quot;</span>

<span class="s">    # Update user</span>
<span class="s">    db.exec(sql&quot;UPDATE users SET email = ? WHERE id = ?&quot;, &quot;updated@example.com&quot;, userId)</span>

<span class="s">    let updatedUser = db.getRow(sql&quot;SELECT email FROM users WHERE id = ?&quot;, userId)</span>
<span class="s">    check updatedUser[0] == &quot;updated@example.com&quot;</span>

<span class="s">    # Delete user</span>
<span class="s">    db.exec(sql&quot;DELETE FROM users WHERE id = ?&quot;, userId)</span>

<span class="s">    let deletedUser = db.getRow(sql&quot;SELECT * FROM users WHERE id = ?&quot;, userId)</span>
<span class="s">    check deletedUser[0] == &quot;&quot;  # No result</span>

<span class="s">  test &quot;Recording storage and retrieval&quot;:</span>
<span class="s">    # Insert recording</span>
<span class="s">    let recordingId = db.insertID(sql</span><span class="s2">&quot;&quot;&quot;</span>
<span class="w">      </span><span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">recordings</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">end_time</span><span class="p">,</span><span class="w"> </span><span class="n">file_size</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">)</span>
<span class="w">      </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="n">datetime</span><span class="p">(</span><span class="sc">&#39;now&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">datetime</span><span class="p">(</span><span class="sc">&#39;now&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;+1 hour&#39;</span><span class="p">),</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="w">    </span><span class="s2">&quot;&quot;&quot;</span><span class="s">, &quot;test_recording.mp4&quot;, 1024000, 3600, &quot;mp4&quot;)</span>

<span class="s">    # Retrieve recording</span>
<span class="s">    let recording = db.getRow(sql&quot;SELECT * FROM recordings WHERE id = ?&quot;, recordingId)</span>
<span class="s">    check recording[1] == &quot;test_recording.mp4&quot;</span>
<span class="s">    check recording[4].parseInt == 1024000</span>

<span class="s">  asyncTest &quot;Event logging&quot;:</span>
<span class="s">    # Log multiple events</span>
<span class="s">    for i in 1..10:</span>
<span class="s">      db.exec(sql</span><span class="s2">&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">severity</span><span class="p">,</span><span class="w"> </span><span class="n">timestamp</span><span class="p">)</span>
<span class="w">        </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="n">datetime</span><span class="p">(</span><span class="sc">&#39;now&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="s2">&quot;&quot;&quot;</span><span class="s">, &quot;motion_detected&quot;, f&quot;Motion detected in zone {i}&quot;, &quot;medium&quot;)</span>

<span class="s">    # Query events</span>
<span class="s">    let events = db.getAllRows(sql&quot;SELECT * FROM events ORDER BY timestamp DESC LIMIT 5&quot;)</span>
<span class="s">    check events.len == 5</span>

<span class="s">    # Test event filtering</span>
<span class="s">    let motionEvents = db.getAllRows(sql</span><span class="s2">&quot;&quot;&quot;</span>
<span class="w">      </span><span class="n">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kn">FROM</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">event_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">AND</span><span class="w"> </span><span class="n">severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="w">    </span><span class="s2">&quot;&quot;&quot;</span><span class="s">, &quot;motion_detected&quot;, &quot;medium&quot;)</span>
<span class="s">    check motionEvents.len == 10</span>
</code></pre></div>

<h2 id="system-testing">System Testing</h2>
<h3 id="performance-testing">Performance Testing</h3>
<p><strong>Performance Test Suite</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/system/test_performance.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">asynctest</span><span class="p">,</span><span class="w"> </span><span class="n">times</span><span class="p">,</span><span class="w"> </span><span class="n">statistics</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">camserver</span><span class="o">/</span><span class="n">cam</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">config</span>

<span class="n">suite</span><span class="w"> </span><span class="s">&quot;Performance Tests&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span>

<span class="w">  </span><span class="n">setup</span><span class="p">:</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setupTestEnvironment</span><span class="p">()</span>

<span class="w">  </span><span class="n">teardown</span><span class="p">:</span>
<span class="w">    </span><span class="n">cleanupTestEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Frame rate consistency&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCamera</span><span class="p">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CameraConfig</span><span class="p">(</span>
<span class="w">      </span><span class="n">devicePath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/dev/video0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">resolution</span><span class="p">:</span><span class="w"> </span><span class="n">Resolution</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="mi">1920</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="mi">1080</span><span class="p">),</span>
<span class="w">      </span><span class="n">framerate</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">camera</span><span class="p">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">frameTimes</span><span class="p">:</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="nb">float</span><span class="o">]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">testDuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10.0</span><span class="w">  </span><span class="c"># seconds</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epochTime</span><span class="p">()</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="n">epochTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">testDuration</span><span class="p">:</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">frameStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epochTime</span><span class="p">()</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">captureFrame</span><span class="p">()</span>
<span class="w">      </span><span class="n">check</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kp">nil</span>

<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">frameTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epochTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">frameStart</span>
<span class="w">      </span><span class="n">frameTimes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">frameTime</span><span class="p">)</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>

<span class="w">    </span><span class="c"># Analyze frame rate consistency</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">avgFrameTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">frameTimes</span><span class="p">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">expectedFrameTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">30.0</span><span class="w">  </span><span class="c"># 30 FPS</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">variance</span><span class="p">(</span><span class="n">frameTimes</span><span class="p">)</span>

<span class="w">    </span><span class="n">echo</span><span class="w"> </span><span class="s">f&quot;Average frame time: {avgFrameTime:.4f}s&quot;</span>
<span class="w">    </span><span class="n">echo</span><span class="w"> </span><span class="s">f&quot;Expected frame time: {expectedFrameTime:.4f}s&quot;</span>
<span class="w">    </span><span class="n">echo</span><span class="w"> </span><span class="s">f&quot;Frame time variance: {variance:.6f}&quot;</span>

<span class="w">    </span><span class="c"># Check if frame rate is within acceptable range</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">abs</span><span class="p">(</span><span class="n">avgFrameTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">expectedFrameTime</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.01</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">variance</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.001</span><span class="w">  </span><span class="c"># Low variance indicates consistent timing</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Memory usage stability&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCamera</span><span class="p">()</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">initialMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMemoryUsage</span><span class="p">()</span>

<span class="w">    </span><span class="c"># Capture frames for extended period</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">1</span><span class="p">..</span><span class="mi">1000</span><span class="p">:</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">captureFrame</span><span class="p">()</span>
<span class="w">      </span><span class="n">check</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kp">nil</span>

<span class="w">      </span><span class="c"># Periodic memory check</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">mod</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="n">currentMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMemoryUsage</span><span class="p">()</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="n">memoryIncrease</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currentMemory</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">initialMemory</span>

<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s">f&quot;Memory usage after {i} frames: {currentMemory} bytes&quot;</span>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s">f&quot;Memory increase: {memoryIncrease} bytes&quot;</span>

<span class="w">        </span><span class="c"># Check for memory leaks</span>
<span class="w">        </span><span class="n">check</span><span class="w"> </span><span class="n">memoryIncrease</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10_000_000</span><span class="w">  </span><span class="c"># Max 10MB increase</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Concurrent streaming performance&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">numStreams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">cameras</span><span class="p">:</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">Camera</span><span class="o">]</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">tasks</span><span class="p">:</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">Future</span><span class="o">[</span><span class="n">void</span><span class="o">]]</span>

<span class="w">    </span><span class="c"># Setup multiple camera streams</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">1</span><span class="p">..</span><span class="n">numStreams</span><span class="p">:</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCamera</span><span class="p">()</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CameraConfig</span><span class="p">(</span>
<span class="w">        </span><span class="n">devicePath</span><span class="p">:</span><span class="w"> </span><span class="s">f&quot;/dev/video{i-1}&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">resolution</span><span class="p">:</span><span class="w"> </span><span class="n">Resolution</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="mi">1280</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="mi">720</span><span class="p">),</span>
<span class="w">        </span><span class="n">framerate</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span>
<span class="w">      </span><span class="p">)</span>

<span class="w">      </span><span class="n">camera</span><span class="p">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">      </span><span class="n">cameras</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Start all cameras concurrently</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epochTime</span><span class="p">()</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cameras</span><span class="p">:</span>
<span class="w">      </span><span class="n">tasks</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">camera</span><span class="p">.</span><span class="n">start</span><span class="p">())</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">all</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">setupTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epochTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startTime</span>

<span class="w">    </span><span class="n">echo</span><span class="w"> </span><span class="s">f&quot;Setup time for {numStreams} streams: {setupTime:.2f}s&quot;</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">setupTime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">5.0</span><span class="w">  </span><span class="c"># Should setup within 5 seconds</span>

<span class="w">    </span><span class="c"># Test concurrent frame capture</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">captureStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epochTime</span><span class="p">()</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">captureTasks</span><span class="p">:</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">Future</span><span class="o">[</span><span class="n">Frame</span><span class="o">]]</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cameras</span><span class="p">:</span>
<span class="w">      </span><span class="n">captureTasks</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">camera</span><span class="p">.</span><span class="n">captureFrame</span><span class="p">())</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">all</span><span class="p">(</span><span class="n">captureTasks</span><span class="p">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">captureTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epochTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">captureStartTime</span>

<span class="w">    </span><span class="n">echo</span><span class="w"> </span><span class="s">f&quot;Concurrent capture time: {captureTime:.4f}s&quot;</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">captureTime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1.0</span><span class="w">  </span><span class="c"># Should capture all frames within 1 second</span>

<span class="w">    </span><span class="c"># Verify all frames captured successfully</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">frames</span><span class="p">:</span>
<span class="w">      </span><span class="n">check</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kp">nil</span>
<span class="w">      </span><span class="n">check</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c"># Cleanup</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cameras</span><span class="p">:</span>
<span class="w">      </span><span class="n">await</span><span class="w"> </span><span class="n">camera</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div>

<h3 id="streaming-performance-tests">Streaming Performance Tests</h3>
<p><strong>RTSP Streaming Tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/system/test_streaming.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">asynctest</span><span class="p">,</span><span class="w"> </span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="n">strutils</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">servers</span><span class="o">/</span><span class="n">streamer</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">config</span>

<span class="n">suite</span><span class="w"> </span><span class="s">&quot;Streaming Performance Tests&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span>

<span class="w">  </span><span class="n">setup</span><span class="p">:</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setupTestEnvironment</span><span class="p">()</span>

<span class="w">  </span><span class="n">teardown</span><span class="p">:</span>
<span class="w">    </span><span class="n">cleanupTestEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;RTSP connection handling&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">streamer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRTSPStreamer</span><span class="p">()</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">streamer</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">554</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Test multiple concurrent connections</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">numClients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">clients</span><span class="p">:</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">Socket</span><span class="o">]</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">1</span><span class="p">..</span><span class="n">numClients</span><span class="p">:</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newSocket</span><span class="p">()</span>
<span class="w">      </span><span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p">(</span><span class="mi">554</span><span class="p">))</span>
<span class="w">      </span><span class="n">clients</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Send RTSP DESCRIBE requests</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clients</span><span class="p">:</span>
<span class="w">      </span><span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;DESCRIBE rtsp://127.0.0.1:554/live RTSP/1.0</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f&quot;CSeq: {i}\r\n&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;User-Agent: Test-Client</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Check responses</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clients</span><span class="p">:</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">recvLine</span><span class="p">()</span>
<span class="w">      </span><span class="n">check</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&quot;RTSP/1.0 200 OK&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Cleanup</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clients</span><span class="p">:</span>
<span class="w">      </span><span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">streamer</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Stream quality under load&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">streamer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRTSPStreamer</span><span class="p">()</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">streamer</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">554</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Simulate high load</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">numConnections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">connections</span><span class="p">:</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">Future</span><span class="o">[</span><span class="n">void</span><span class="o">]]</span>

<span class="w">    </span><span class="k">proc</span><span class="w"> </span><span class="nf">simulateClient</span><span class="p">(</span><span class="n">clientId</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span><span class="p">):</span><span class="w"> </span><span class="n">Future</span><span class="o">[</span><span class="n">void</span><span class="o">]</span><span class="w"> </span><span class="sx">{.async.}</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newSocket</span><span class="p">()</span>
<span class="w">      </span><span class="k">try</span><span class="p">:</span>
<span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p">(</span><span class="mi">554</span><span class="p">))</span>

<span class="w">        </span><span class="c"># RTSP handshake</span>
<span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;DESCRIBE rtsp://127.0.0.1:554/live RTSP/1.0</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f&quot;CSeq: {clientId}\r\n\r\n&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">recvLine</span><span class="p">()</span>
<span class="w">        </span><span class="n">check</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&quot;RTSP/1.0&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="c"># Simulate streaming for a short period</span>
<span class="w">        </span><span class="n">await</span><span class="w"> </span><span class="n">sleepAsync</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="w">      </span><span class="k">finally</span><span class="p">:</span>
<span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="w">    </span><span class="c"># Start all client simulations</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">1</span><span class="p">..</span><span class="n">numConnections</span><span class="p">:</span>
<span class="w">      </span><span class="n">connections</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">simulateClient</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

<span class="w">    </span><span class="c"># Wait for all clients to complete</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">all</span><span class="p">(</span><span class="n">connections</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Check server is still responsive</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">testClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newSocket</span><span class="p">()</span>
<span class="w">    </span><span class="n">testClient</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p">(</span><span class="mi">554</span><span class="p">))</span>
<span class="w">    </span><span class="n">testClient</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;DESCRIBE rtsp://127.0.0.1:554/live RTSP/1.0</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">testClient</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;CSeq: 999</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">testClient</span><span class="p">.</span><span class="n">recvLine</span><span class="p">()</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&quot;RTSP/1.0 200 OK&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">testClient</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">streamer</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div>

<h2 id="security-testing">Security Testing</h2>
<h3 id="security-test-suite">Security Test Suite</h3>
<p><strong>Security Tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/system/test_security.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">asynctest</span><span class="p">,</span><span class="w"> </span><span class="n">httpclient</span><span class="p">,</span><span class="w"> </span><span class="n">json</span><span class="p">,</span><span class="w"> </span><span class="n">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">servers</span><span class="o">/</span><span class="n">httpapi</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">config</span>

<span class="n">suite</span><span class="w"> </span><span class="s">&quot;Security Tests&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="kd">var</span>
<span class="w">    </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span>
<span class="w">    </span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">AsyncHttpClient</span>

<span class="w">  </span><span class="n">setup</span><span class="p">:</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setupTestEnvironment</span><span class="p">()</span>
<span class="w">    </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAsyncHttpClient</span><span class="p">()</span>

<span class="w">  </span><span class="n">teardown</span><span class="p">:</span>
<span class="w">    </span><span class="n">cleanupTestEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Authentication bypass attempts&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Test access without authentication</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/admin/users&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http401</span>

<span class="w">    </span><span class="c"># Test with malformed token</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newHttpHeaders</span><span class="p">({</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Bearer malformed.token.here&quot;</span><span class="p">})</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">malformedResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/admin/users&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">malformedResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http401</span>

<span class="w">    </span><span class="c"># Test with expired token</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">expiredToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1MTYyMzkwMjJ9&quot;</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newHttpHeaders</span><span class="p">({</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">f&quot;Bearer {expiredToken}&quot;</span><span class="p">})</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">expiredResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/admin/users&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">expiredResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http401</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;SQL injection prevention&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Test SQL injection in login</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">sqlInjectionPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin&#39;; DROP TABLE users; --&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;password&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">post</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;http://127.0.0.1:8080/api/auth/login&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">sqlInjectionPayload</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c"># Should not return success or cause server error</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">Http400</span><span class="p">,</span><span class="w"> </span><span class="n">Http401</span><span class="o">]</span>

<span class="w">    </span><span class="c"># Verify users table still exists</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">usersResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/admin/users&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Should return 401 (unauthorized) not 500 (server error)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">usersResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http401</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;XSS prevention&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Test XSS in user input</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">xssPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;script&gt;alert(&#39;XSS&#39;)&lt;/script&gt;&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Normal Title&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">post</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;http://127.0.0.1:8080/api/events&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">xssPayload</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c"># Should sanitize input</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span><span class="p">:</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">responseData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">await</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">responseData</span><span class="o">[</span><span class="s">&quot;description&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span>
<span class="w">      </span><span class="n">check</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">description</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;&lt;script&gt;&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Rate limiting&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Test rate limiting on authentication endpoint</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">loginPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;testuser&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;wrongpassword&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">responses</span><span class="p">:</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">AsyncResponse</span><span class="o">]</span>

<span class="w">    </span><span class="c"># Send many requests quickly</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">1</span><span class="p">..</span><span class="mi">20</span><span class="p">:</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">post</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;http://127.0.0.1:8080/api/auth/login&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">loginPayload</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span><span class="n">responses</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Check if rate limiting kicks in</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">rateLimitedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">responses</span><span class="p">:</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http429</span><span class="p">:</span>
<span class="w">        </span><span class="n">rateLimitedCount</span><span class="p">.</span><span class="n">inc</span>

<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">rateLimitedCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c"># Some requests should be rate limited</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;HTTPS redirect&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Test HTTP to HTTPS redirect (if configured)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">httpResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/status&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">httpResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http301</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">httpResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http302</span><span class="p">:</span>
<span class="w">      </span><span class="k">let</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">httpResponse</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="s">&quot;Location&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">check</span><span class="w"> </span><span class="n">location</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&quot;https://&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="acceptance-testing">Acceptance Testing</h2>
<h3 id="user-acceptance-tests">User Acceptance Tests</h3>
<p><strong>User Scenario Tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/acceptance/test_user_scenarios.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">unittest2</span><span class="p">,</span><span class="w"> </span><span class="n">asynctest</span><span class="p">,</span><span class="w"> </span><span class="n">httpclient</span><span class="p">,</span><span class="w"> </span><span class="n">json</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span>
<span class="kn">import</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">config</span>

<span class="n">suite</span><span class="w"> </span><span class="s">&quot;User Acceptance Tests&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="kd">var</span>
<span class="w">    </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="n">TestEnvironment</span>
<span class="w">    </span><span class="n">httpClient</span><span class="p">:</span><span class="w"> </span><span class="n">AsyncHttpClient</span>
<span class="w">    </span><span class="n">wsClient</span><span class="p">:</span><span class="w"> </span><span class="n">WebSocket</span>
<span class="w">    </span><span class="n">authToken</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span>

<span class="w">  </span><span class="n">setup</span><span class="p">:</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setupTestEnvironment</span><span class="p">()</span>
<span class="w">    </span><span class="n">httpClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAsyncHttpClient</span><span class="p">()</span>

<span class="w">    </span><span class="c"># Authenticate test user</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">loginResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">post</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;http://127.0.0.1:8080/api/auth/login&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="p">(</span><span class="o">%*</span><span class="p">{</span><span class="s">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;testuser&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;testpass&quot;</span><span class="p">})</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">loginData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">await</span><span class="w"> </span><span class="n">loginResponse</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
<span class="w">    </span><span class="n">authToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loginData</span><span class="o">[</span><span class="s">&quot;token&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span>

<span class="w">    </span><span class="n">httpClient</span><span class="p">.</span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newHttpHeaders</span><span class="p">({</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">f&quot;Bearer {authToken}&quot;</span><span class="p">})</span>
<span class="w">    </span><span class="n">wsClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitFor</span><span class="w"> </span><span class="n">newWebSocket</span><span class="p">(</span><span class="s">&quot;ws://127.0.0.1:8080/api/v1/ws&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>

<span class="w">  </span><span class="n">teardown</span><span class="p">:</span>
<span class="w">    </span><span class="n">cleanupTestEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="w">    </span><span class="n">httpClient</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">wsClient</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kp">nil</span><span class="p">:</span>
<span class="w">      </span><span class="n">wsClient</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Complete camera setup workflow&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># 1. User views current camera status</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">statusResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/camera/status&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">statusResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="c"># 2. User configures camera settings</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">settingsPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;resolution&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1920</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;height&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1080</span><span class="p">},</span>
<span class="w">      </span><span class="s">&quot;framerate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;quality&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;h264&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">configResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">put</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;http://127.0.0.1:8080/api/camera/settings&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">settingsPayload</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">configResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="c"># 3. User starts streaming</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">startResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/camera/start&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">startResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="c"># 4. User verifies streaming status</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">streamingStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/camera/status&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">statusData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">await</span><span class="w"> </span><span class="n">streamingStatus</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">statusData</span><span class="o">[</span><span class="s">&quot;status&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;streaming&quot;</span>

<span class="w">    </span><span class="c"># 5. User captures snapshot</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">snapshotResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/camera/snapshot&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">snapshotResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">snapshotResponse</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">).</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&quot;image/&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;Live monitoring workflow&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># 1. User subscribes to live status updates</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">subscribeMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;subscribe&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;channel&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;status_subscription&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">wsClient</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">$</span><span class="n">subscribeMsg</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Wait for subscription confirmation</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">confirmMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">wsClient</span><span class="p">.</span><span class="n">receiveStrPacket</span><span class="p">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">confirmData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">confirmMsg</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">confirmData</span><span class="o">[</span><span class="s">&quot;type&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;subscription_confirmed&quot;</span>

<span class="w">    </span><span class="c"># 2. User subscribes to event notifications</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">eventSubscribeMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;subscribe&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;channel&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;events&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;event_subscription&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">wsClient</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">$</span><span class="n">eventSubscribeMsg</span><span class="p">)</span>

<span class="w">    </span><span class="c"># 3. User triggers recording via API</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">recordResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/recording/start&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">recordResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="c"># 4. User should receive real-time status update</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">statusUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">wsClient</span><span class="p">.</span><span class="n">receiveStrPacket</span><span class="p">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">updateData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">statusUpdate</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">updateData</span><span class="o">[</span><span class="s">&quot;type&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;status_update&quot;</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">updateData</span><span class="o">[</span><span class="s">&quot;data&quot;</span><span class="o">][</span><span class="s">&quot;recording&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getBool</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kp">true</span>

<span class="w">    </span><span class="c"># 5. User stops recording</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">stopResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/recording/stop&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">stopResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="c"># 6. User should receive recording stopped notification</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">stopUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">wsClient</span><span class="p">.</span><span class="n">receiveStrPacket</span><span class="p">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">stopData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">stopUpdate</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">stopData</span><span class="o">[</span><span class="s">&quot;data&quot;</span><span class="o">][</span><span class="s">&quot;recording&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getBool</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kp">false</span>

<span class="w">  </span><span class="n">asyncTest</span><span class="w"> </span><span class="s">&quot;User management workflow&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Admin user manages other users</span>

<span class="w">    </span><span class="c"># 1. Admin views current users</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">usersResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080/api/admin/users&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">usersResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="c"># 2. Admin creates new user</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">newUserPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;newoperator&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;operator@example.com&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;operator&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;newuserpass&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">createResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">post</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;http://127.0.0.1:8080/api/admin/users&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">newUserPayload</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">createResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http201</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">createdUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">await</span><span class="w"> </span><span class="n">createResponse</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createdUser</span><span class="o">[</span><span class="s">&quot;id&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getInt</span>

<span class="w">    </span><span class="c"># 3. Admin updates user role</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">updatePayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span><span class="s">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;viewer&quot;</span><span class="p">}</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">updateResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">put</span><span class="p">(</span>
<span class="w">      </span><span class="s">f&quot;http://127.0.0.1:8080/api/admin/users/{userId}&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">updatePayload</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">updateResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http200</span>

<span class="w">    </span><span class="c"># 4. Admin verifies user update</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">updatedUserResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">f&quot;http://127.0.0.1:8080/api/admin/users/{userId}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">updatedUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">await</span><span class="w"> </span><span class="n">updatedUserResponse</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">updatedUser</span><span class="o">[</span><span class="s">&quot;role&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">getStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;viewer&quot;</span>

<span class="w">    </span><span class="c"># 5. Admin deletes user</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">deleteResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">httpClient</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="s">f&quot;http://127.0.0.1:8080/api/admin/users/{userId}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">check</span><span class="w"> </span><span class="n">deleteResponse</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Http204</span>
</code></pre></div>

<h2 id="test-automation">Test Automation</h2>
<h3 id="continuous-integration-tests">Continuous Integration Tests</h3>
<p><strong>CI/CD Pipeline Configuration</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Test Suite</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">main</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">develop</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">unit-tests</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setup Nim</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jiro4989/setup-nim-action@v1</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">nim-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1.6.14&#39;</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">sudo apt-get update</span>
<span class="w">        </span><span class="no">sudo apt-get install -y \</span>
<span class="w">          </span><span class="no">libgstreamer1.0-dev \</span>
<span class="w">          </span><span class="no">libgstreamer-plugins-base1.0-dev \</span>
<span class="w">          </span><span class="no">libv4l-dev \</span>
<span class="w">          </span><span class="no">ffmpeg \</span>
<span class="w">          </span><span class="no">sqlite3</span>
<span class="w">        </span><span class="no">nimble install -d</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run unit tests</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nimble test</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload coverage</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov/codecov-action@v3</span>

<span class="w">  </span><span class="nt">integration-tests</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unit-tests</span>

<span class="w">    </span><span class="nt">services</span><span class="p">:</span>
<span class="w">      </span><span class="nt">postgres</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">          </span><span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testpass</span>
<span class="w">          </span><span class="nt">POSTGRES_DB</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rotordream_test</span>
<span class="w">        </span><span class="nt">options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">          </span><span class="no">--health-cmd pg_isready</span>
<span class="w">          </span><span class="no">--health-interval 10s</span>
<span class="w">          </span><span class="no">--health-timeout 5s</span>
<span class="w">          </span><span class="no">--health-retries 5</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setup test environment</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">docker build -f Dockerfile.test -t rotordream-test .</span>
<span class="w">        </span><span class="no">docker run --network host -v $PWD:/app rotordream-test nimble integration_test</span>

<span class="w">  </span><span class="nt">system-tests</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">integration-tests</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setup virtual camera</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">sudo modprobe v4l2loopback devices=1 video_nr=0 card_label=&quot;Virtual Camera&quot;</span>
<span class="w">        </span><span class="no">ffmpeg -f lavfi -i testsrc=duration=60:size=1920x1080:rate=30 -f v4l2 /dev/video0 &amp;</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run system tests</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">docker build -f Dockerfile.test -t rotordream-test .</span>
<span class="w">        </span><span class="no">docker run --device=/dev/video0 --network host rotordream-test nimble system_test</span>

<span class="w">  </span><span class="nt">performance-tests</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system-tests</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run performance benchmarks</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">docker build -f Dockerfile.test -t rotordream-test .</span>
<span class="w">        </span><span class="no">docker run --network host rotordream-test nimble performance_test</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload performance results</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v3</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">performance-results</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tests/performance_results.json</span>
</code></pre></div>

<h3 id="test-data-management">Test Data Management</h3>
<p><strong>Test Data Generator</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># tests/utils/test_data_generator.nim</span>
<span class="kn">import</span><span class="w"> </span><span class="n">json</span><span class="p">,</span><span class="w"> </span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">times</span><span class="p">,</span><span class="w"> </span><span class="n">os</span>

<span class="k">proc</span><span class="w"> </span><span class="nf">generateTestImages</span><span class="o">*</span><span class="p">(</span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">outputDir</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="sd">## Generate test images for camera simulation</span>
<span class="w">  </span><span class="n">createDir</span><span class="p">(</span><span class="n">outputDir</span><span class="p">)</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">1</span><span class="p">..</span><span class="n">count</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">f&quot;test_image_{i:04d}.jpg&quot;</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">filepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outputDir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">filename</span>

<span class="w">    </span><span class="c"># Generate using FFmpeg</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">f&quot;ffmpeg -f lavfi -i testsrc=duration=1:size=1920x1080:rate=1 -vframes 1 -q:v 2 {filepath}&quot;</span>
<span class="w">    </span><span class="k">discard</span><span class="w"> </span><span class="n">execShellCmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

<span class="k">proc</span><span class="w"> </span><span class="nf">generateTestConfig</span><span class="o">*</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="sd">## Generate test configuration file</span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;camera&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/dev/video0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;resolution&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1920</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;height&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1080</span><span class="p">},</span>
<span class="w">      </span><span class="s">&quot;framerate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;h264&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s">&quot;network&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;http_port&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8080</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;rtsp_port&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">554</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;websocket_port&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8081</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s">&quot;storage&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;base_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/tmp/recordings&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;max_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;retention_days&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s">&quot;authentication&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;jwt_secret&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;test_secret_key_12345&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;token_expiry&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">writeFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">pretty</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

<span class="k">proc</span><span class="w"> </span><span class="nf">generateTestUsers</span><span class="o">*</span><span class="p">(</span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span><span class="p">):</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">JsonNode</span><span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="sd">## Generate test user data</span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@[]</span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="n">roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;operator&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;viewer&quot;</span><span class="o">]</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">1</span><span class="p">..</span><span class="n">count</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">f&quot;testuser{i}&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">f&quot;user{i}@example.com&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">roles</span><span class="p">),</span>
<span class="w">      </span><span class="s">&quot;created_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="n">now</span><span class="p">(),</span>
<span class="w">      </span><span class="s">&quot;active&quot;</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

<span class="c"># Test data initialization</span>
<span class="k">when</span><span class="w"> </span><span class="n">isMainModule</span><span class="p">:</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="s">&quot;Generating test data...&quot;</span>

<span class="w">  </span><span class="n">generateTestImages</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tests/data/test_images&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">generateTestConfig</span><span class="p">(</span><span class="s">&quot;tests/data/test_config.json&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="n">testUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateTestUsers</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="w">  </span><span class="n">writeFile</span><span class="p">(</span><span class="s">&quot;tests/data/test_users.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pretty</span><span class="p">(</span><span class="o">%</span><span class="n">testUsers</span><span class="p">))</span>

<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="s">&quot;Test data generation complete!&quot;</span>
</code></pre></div>

<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../operations/build-deploy.md">Build &amp; Deploy</a> - Deployment testing</li>
<li><a href="../operations/monitoring.md">Monitoring</a> - Test monitoring</li>
<li><a href="../api/http-api.md">API Reference</a> - API testing</li>
<li><a href="../operations/performance.md">Performance</a> - Performance testing</li>
</ul>
<hr />
<p><em>Comprehensive testing strategies covering all aspects of system validation and quality assurance</em></p>
            </div>
            <footer class="content-footer">
                <p>Copyright © 2025 Rotoclear</p>
            </footer>
        </main>
        
        <button class="mobile-menu-toggle" id="menuToggle" aria-label="Toggle menu">☰</button>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'Inter, sans-serif'
        });
        
        // Syntax highlighting
        hljs.highlightAll();
        
        // Mobile menu toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');
        
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target) &&
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
        
        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
    </script>
</body>
</html>