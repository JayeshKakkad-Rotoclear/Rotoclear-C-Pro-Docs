<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADR-0002 Corun Framework - RotoClear Camera Server Documentation</title>
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><a href="/index.html">RotoClear Docs</a></h1>
                <p>Camera Server Documentation</p>
            </div>
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item depth-0">
<a href="/index.html">Home</a>
</li>
<li class="nav-item depth-0">
<a href="/getting-started.html">Getting Started</a>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Architecture</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/architecture/overview.html">Overview</a>
</li>
<li class="nav-item depth-1">
<a href="/architecture/state-management.html">State Management</a>
</li>
<li class="nav-item depth-1">
<a href="/architecture/camera-pipeline.html">Camera Pipeline</a>
</li>
<li class="nav-item depth-1">
<a href="/architecture/metadata-sqlite.html">Metadata & SQLite</a>
</li>
<li class="nav-folder depth-1">
<span class="folder-title">Decisions</span>
<ul class="nav-submenu">
<li class="nav-item depth-2">
<a href="/architecture/decisions/ADR-0001-nim-language.html">ADR-0001 Nim Language</a>
</li>
<li class="nav-item depth-2 active">
<a href="/architecture/decisions/ADR-0002-corun-framework.html">ADR-0002 Corun Framework</a>
</li>
<li class="nav-item depth-2">
<a href="/architecture/decisions/ADR-0003-observable-state.html">ADR-0003 Observable State</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">API Reference</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/api/README.html">Overview</a>
</li>
<li class="nav-item depth-1">
<a href="/api/websocket-api.html">WebSocket API</a>
</li>
<li class="nav-item depth-1">
<a href="/api/http-api.html">HTTP API</a>
</li>
<li class="nav-item depth-1">
<a href="/api/rtsp-streaming.html">RTSP Streaming</a>
</li>
<li class="nav-folder depth-1">
<span class="folder-title">Examples</span>
<ul class="nav-submenu">
<li class="nav-item depth-2">
<a href="/api/examples/python-client.html">Python Client</a>
</li>
<li class="nav-item depth-2">
<a href="/api/examples/javascript-client.html">JavaScript Client</a>
</li>
<li class="nav-item depth-2">
<a href="/api/examples/csharp-client.html">C# Client</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Configuration</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/configuration/environments.html">Environments</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/factory-config.html">Factory Config</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/license-config.html">License Config</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/deployment-variants.html">Deployment Variants</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/camera-system.html">Camera System</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/network.html">Network</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/storage-backup.html">Storage & Backup</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/authentication.html">Authentication</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Camera System</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/camera/hardware-interface.html">Hardware Interface</a>
</li>
<li class="nav-item depth-1">
<a href="/camera/streaming.html">Streaming</a>
</li>
<li class="nav-item depth-1">
<a href="/camera/recording.html">Recording</a>
</li>
<li class="nav-item depth-1">
<a href="/camera/image-processing.html">Image Processing</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Operations</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/operations/build-and-deploy.html">Build and Deploy</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/build-deploy.html">Build & Deploy (Alt)</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/monitoring.html">Monitoring</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/performance.html">Performance</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/troubleshooting.html">Troubleshooting</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Security</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/security/authentication.html">Authentication</a>
</li>
<li class="nav-item depth-1">
<a href="/security/permissions.html">Permissions</a>
</li>
<li class="nav-item depth-1">
<a href="/security/ssl-certificates.html">SSL Certificates</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Testing</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/testing/testing-strategy.html">Strategy</a>
</li>
<li class="nav-item depth-1">
<a href="/testing/strategies.html">Strategies</a>
</li>
<li class="nav-item depth-1">
<a href="/testing/test-cases.html">Test Cases</a>
</li>
<li class="nav-item depth-1">
<a href="/testing/validation.html">Validation</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Integration</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/integration/onvif-protocol.html">ONVIF Protocol</a>
</li>
<li class="nav-item depth-1">
<a href="/integration/third-party.html">Third Party</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Reference</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/reference/glossary.html">Glossary</a>
</li>
<li class="nav-item depth-1">
<a href="/reference/requirements.html">Requirements</a>
</li>
<li class="nav-item depth-1">
<a href="/reference/state-observables.html">State Observables</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Releases</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/releases/CHANGELOG.html">Changelog</a>
</li>
</ul>
</li>
<li class="nav-item depth-0">
<a href="/glossary.html">Glossary</a>
</li>
                </ul>
            </nav>
        </aside>
        
        <main class="content">
            <div class="content-wrapper">
                <h1 id="adr-0002-corun-async-framework-selection">ADR-0002: Corun Async Framework Selection</h1>
<p><strong>Status</strong>: Accepted<br />
<strong>Date</strong>: 2024-01-20<br />
<strong>Deciders</strong>: Engineering Team  </p>
<h2 id="context">Context</h2>
<p>The RotoClear camera server requires handling multiple concurrent operations:</p>
<ul>
<li>Real-time WebSocket connections (10+ simultaneous clients)</li>
<li>HTTP API requests and file transfers</li>
<li>Camera frame capture and processing</li>
<li>System monitoring and health checks</li>
<li>Network discovery and ONVIF communication</li>
</ul>
<p>We needed an async framework that provides:<br />
- High-performance concurrent I/O<br />
- WebSocket support with real-time capabilities<br />
- HTTP server with file upload/download<br />
- Low memory overhead for embedded deployment<br />
- Integration with Nim's type system</p>
<h2 id="decision">Decision</h2>
<p>We selected <strong>Corun</strong> as the async runtime framework for the RotoClear camera server.</p>
<h2 id="rationale">Rationale</h2>
<h3 id="performance-characteristics">Performance Characteristics</h3>
<ul>
<li><strong>Event Loop</strong>: Single-threaded event loop with cooperative multitasking</li>
<li><strong>Memory Efficient</strong>: &lt;5MB additional RAM overhead</li>
<li><strong>Low Latency</strong>: Sub-millisecond task switching</li>
<li><strong>Scalable</strong>: Handles 100+ concurrent connections on embedded hardware</li>
</ul>
<h3 id="websocket-support">WebSocket Support</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># Real-time WebSocket handling</span>
<span class="k">proc</span><span class="w"> </span><span class="nf">handleWebSocket</span><span class="p">(</span><span class="n">ws</span><span class="p">:</span><span class="w"> </span><span class="n">WebSocket</span><span class="p">)</span><span class="w"> </span><span class="sx">{.async.}</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="n">ws</span><span class="p">.</span><span class="n">readyState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ReadyState</span><span class="p">.</span><span class="n">Open</span><span class="p">:</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ws</span><span class="p">.</span><span class="n">receiveText</span><span class="p">()</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">processApiMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">)</span>
</code></pre></div>

<h3 id="http-server-capabilities">HTTP Server Capabilities</h3>
<ul>
<li><strong>Static Files</strong>: Efficient static file serving</li>
<li><strong>REST API</strong>: JSON request/response handling</li>
<li><strong>File Uploads</strong>: Multipart form data processing</li>
<li><strong>HTTPS</strong>: TLS/SSL support with certificate management</li>
</ul>
<h3 id="integration-benefits">Integration Benefits</h3>
<ul>
<li><strong>Nim Native</strong>: Written specifically for Nim, excellent type integration</li>
<li><strong>Exception Safe</strong>: Proper async exception propagation</li>
<li><strong>Debugging</strong>: Stack traces work correctly with async code</li>
</ul>
<h2 id="architecture-implementation">Architecture Implementation</h2>
<h3 id="server-structure">Server Structure</h3>
<p>From <code>src/servers/webserver.nim</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="n">corun</span>
<span class="kn">import</span><span class="w"> </span><span class="n">corun</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">webserver</span>

<span class="k">proc</span><span class="w"> </span><span class="nf">startWebServer</span><span class="o">*</span><span class="p">()</span><span class="w"> </span><span class="sx">{.async.}</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newWebserver</span><span class="p">()</span>
<span class="w">  </span><span class="n">server</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/api&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">upgradeToMainThreadWebsocket</span><span class="p">)</span>
<span class="w">  </span><span class="n">server</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">serveStaticFiles</span><span class="p">)</span>
<span class="w">  </span><span class="n">await</span><span class="w"> </span><span class="n">server</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="n">httpPort</span><span class="p">)</span>
</code></pre></div>

<h3 id="concurrent-task-management">Concurrent Task Management</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># Multiple concurrent services</span>
<span class="k">proc</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="sx">{.async.}</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">await</span><span class="w"> </span><span class="n">all</span><span class="p">(</span><span class="o">[</span>
<span class="w">    </span><span class="n">RCHttpServer</span><span class="p">.</span><span class="n">start</span><span class="p">(),</span>
<span class="w">    </span><span class="n">RCHttpsServer</span><span class="p">.</span><span class="n">start</span><span class="p">(),</span>
<span class="w">    </span><span class="n">CamClient</span><span class="p">.</span><span class="n">start</span><span class="p">(),</span>
<span class="w">    </span><span class="n">initState</span><span class="p">()</span>
<span class="w">  </span><span class="o">]</span><span class="p">)</span>
</code></pre></div>

<h2 id="alternatives-considered">Alternatives Considered</h2>
<h3 id="asyncdispatch-nim-standard">AsyncDispatch (Nim Standard)</h3>
<ul>
<li><strong>Pros</strong>: Part of standard library, well-tested</li>
<li><strong>Cons</strong>: Limited WebSocket support, callback-heavy API, memory overhead</li>
</ul>
<h3 id="httpbeast">HttpBeast</h3>
<ul>
<li><strong>Pros</strong>: High performance HTTP server</li>
<li><strong>Cons</strong>: HTTP-only, no WebSocket support, complex integration</li>
</ul>
<h3 id="jester">Jester</h3>
<ul>
<li><strong>Pros</strong>: Flask-like web framework, good documentation</li>
<li><strong>Cons</strong>: Synchronous model, performance limitations</li>
</ul>
<h3 id="custom-event-loop">Custom Event Loop</h3>
<ul>
<li><strong>Pros</strong>: Maximum control and optimization</li>
<li><strong>Cons</strong>: Development time, complexity, maintenance burden</li>
</ul>
<h2 id="implementation-details">Implementation Details</h2>
<h3 id="dependency-configuration">Dependency Configuration</h3>
<p>From <code>rotordream.nimble</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">requires</span><span class="w"> </span><span class="s">&quot;corun &gt;= 0.7.10&quot;</span>
</code></pre></div>

<h3 id="websocket-api-integration">WebSocket API Integration</h3>
<p>The entire WebSocket API system is built on Corun:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># From src/servers/clients.nim</span>
<span class="k">proc</span><span class="w"> </span><span class="nf">processApiHttpRequest</span><span class="o">*</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">JsonNode</span><span class="p">):</span><span class="w"> </span><span class="p">(</span><span class="nb">string</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="c"># Process API requests through Corun async system</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">validateCredentials</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">):</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handleApiRequest</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span>
<span class="w">  </span><span class="k">else</span><span class="p">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Unauthorized&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">401</span><span class="p">)</span>
</code></pre></div>

<h3 id="real-time-state-broadcasting">Real-time State Broadcasting</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># Efficient broadcast to multiple clients using Corun WebSocket</span>
<span class="k">proc</span><span class="w"> </span><span class="nf">broadcastStateChange</span><span class="o">*</span><span class="p">(</span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="n">JsonNode</span><span class="p">)</span><span class="w"> </span><span class="sx">{.async.}</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%*</span><span class="p">{</span><span class="s">&quot;state&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">value</span><span class="p">}</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">connectedClients</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">readyState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ReadyState</span><span class="p">.</span><span class="n">Open</span><span class="p">:</span>
<span class="w">      </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">$</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>

<h2 id="performance-metrics">Performance Metrics</h2>
<p>Based on testing with embedded ARM64 hardware:</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Achieved</th>
</tr>
</thead>
<tbody>
<tr>
<td>WebSocket Connections</td>
<td>10+</td>
<td>25+ simultaneous</td>
</tr>
<tr>
<td>Message Latency</td>
<td>&lt;10ms</td>
<td>~3ms average</td>
</tr>
<tr>
<td>Memory Overhead</td>
<td>&lt;10MB</td>
<td>~5MB</td>
</tr>
<tr>
<td>CPU Usage</td>
<td>&lt;20%</td>
<td>~12% at 25 connections</td>
</tr>
</tbody>
</table>
<h2 id="consequences">Consequences</h2>
<h3 id="positive">Positive</h3>
<ul>
<li><strong>Real-time Performance</strong>: Sub-10ms message latency for WebSocket API</li>
<li><strong>Resource Efficiency</strong>: Low memory and CPU overhead</li>
<li><strong>Development Speed</strong>: Clean async/await syntax</li>
<li><strong>Reliability</strong>: Proper error handling and connection management</li>
</ul>
<h3 id="negative">Negative</h3>
<ul>
<li><strong>Learning Curve</strong>: Team needed to learn async programming patterns</li>
<li><strong>Debugging Complexity</strong>: Async stack traces can be complex</li>
<li><strong>Ecosystem</strong>: Fewer third-party libraries compared to synchronous frameworks</li>
</ul>
<h3 id="neutral">Neutral</h3>
<ul>
<li><strong>Single-threaded</strong>: Adequate for I/O-bound workloads, but CPU-intensive tasks need thread pools</li>
<li><strong>Community Size</strong>: Smaller community but active development</li>
</ul>
<h2 id="risk-mitigation">Risk Mitigation</h2>
<h3 id="thread-pool-integration">Thread Pool Integration</h3>
<p>For CPU-intensive tasks (image processing):</p>
<div class="codehilite"><pre><span></span><code><span class="c"># Offload heavy work to thread pool</span>
<span class="k">proc</span><span class="w"> </span><span class="nf">processImage</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">byte</span><span class="o">]</span><span class="p">):</span><span class="w"> </span><span class="n">Future</span><span class="o">[</span><span class="nb">seq</span><span class="o">[</span><span class="n">byte</span><span class="o">]]</span><span class="w"> </span><span class="sx">{.async.}</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">spawnAsync</span><span class="p">(</span><span class="n">proc</span><span class="p">():</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">byte</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="c"># Heavy image processing work</span>
<span class="w">    </span><span class="n">encodeJpeg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
</code></pre></div>

<h3 id="connection-management">Connection Management</h3>
<p>Implement connection limits and graceful degradation:</p>
<div class="codehilite"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">MAX_CONNECTIONS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span>

<span class="k">proc</span><span class="w"> </span><span class="nf">acceptConnection</span><span class="p">(</span><span class="n">server</span><span class="p">:</span><span class="w"> </span><span class="n">Webserver</span><span class="p">)</span><span class="w"> </span><span class="sx">{.async.}</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">connectedClients</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_CONNECTIONS</span><span class="p">:</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">rejectConnection</span><span class="p">(</span><span class="s">&quot;Server busy&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span>
</code></pre></div>

<h2 id="monitoring">Monitoring</h2>
<p>Key metrics monitored in production:<br />
- <strong>Connection Count</strong>: Active WebSocket connections<br />
- <strong>Message Queue Depth</strong>: Pending async operations<br />
- <strong>Memory Usage</strong>: Corun runtime memory consumption<br />
- <strong>Response Time</strong>: API endpoint latency percentiles</p>
<h2 id="review-date">Review Date</h2>
<p>This decision will be reviewed in Q2 2025 based on:<br />
- Performance under production load<br />
- Development team productivity<br />
- Corun framework evolution and support<br />
- Alternative framework maturity (especially Nim 2.0+ async improvements)</p>
            </div>
            <footer class="content-footer">
                <p>Copyright © 2025 Rotoclear</p>
            </footer>
        </main>
        
        <button class="mobile-menu-toggle" id="menuToggle" aria-label="Toggle menu">☰</button>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'Inter, sans-serif'
        });
        
        // Syntax highlighting
        hljs.highlightAll();
        
        // Mobile menu toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');
        
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target) &&
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
        
        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
    </script>
</body>
</html>