<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Pipeline - RotoClear Camera Server Documentation</title>
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><a href="/index.html">RotoClear Docs</a></h1>
                <p>Camera Server Documentation</p>
            </div>
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item depth-0">
<a href="/index.html">Home</a>
</li>
<li class="nav-item depth-0">
<a href="/getting-started.html">Getting Started</a>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Architecture</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/architecture/overview.html">Overview</a>
</li>
<li class="nav-item depth-1">
<a href="/architecture/state-management.html">State Management</a>
</li>
<li class="nav-item depth-1 active">
<a href="/architecture/camera-pipeline.html">Camera Pipeline</a>
</li>
<li class="nav-item depth-1">
<a href="/architecture/metadata-sqlite.html">Metadata & SQLite</a>
</li>
<li class="nav-folder depth-1">
<span class="folder-title">Decisions</span>
<ul class="nav-submenu">
<li class="nav-item depth-2">
<a href="/architecture/decisions/ADR-0001-nim-language.html">ADR-0001 Nim Language</a>
</li>
<li class="nav-item depth-2">
<a href="/architecture/decisions/ADR-0002-corun-framework.html">ADR-0002 Corun Framework</a>
</li>
<li class="nav-item depth-2">
<a href="/architecture/decisions/ADR-0003-observable-state.html">ADR-0003 Observable State</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">API Reference</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/api/README.html">Overview</a>
</li>
<li class="nav-item depth-1">
<a href="/api/websocket-api.html">WebSocket API</a>
</li>
<li class="nav-item depth-1">
<a href="/api/http-api.html">HTTP API</a>
</li>
<li class="nav-item depth-1">
<a href="/api/rtsp-streaming.html">RTSP Streaming</a>
</li>
<li class="nav-folder depth-1">
<span class="folder-title">Examples</span>
<ul class="nav-submenu">
<li class="nav-item depth-2">
<a href="/api/examples/python-client.html">Python Client</a>
</li>
<li class="nav-item depth-2">
<a href="/api/examples/javascript-client.html">JavaScript Client</a>
</li>
<li class="nav-item depth-2">
<a href="/api/examples/csharp-client.html">C# Client</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Configuration</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/configuration/environments.html">Environments</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/factory-config.html">Factory Config</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/license-config.html">License Config</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/deployment-variants.html">Deployment Variants</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/camera-system.html">Camera System</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/network.html">Network</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/storage-backup.html">Storage & Backup</a>
</li>
<li class="nav-item depth-1">
<a href="/configuration/authentication.html">Authentication</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Camera System</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/camera/hardware-interface.html">Hardware Interface</a>
</li>
<li class="nav-item depth-1">
<a href="/camera/streaming.html">Streaming</a>
</li>
<li class="nav-item depth-1">
<a href="/camera/recording.html">Recording</a>
</li>
<li class="nav-item depth-1">
<a href="/camera/image-processing.html">Image Processing</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Operations</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/operations/build-and-deploy.html">Build and Deploy</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/build-deploy.html">Build & Deploy (Alt)</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/monitoring.html">Monitoring</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/performance.html">Performance</a>
</li>
<li class="nav-item depth-1">
<a href="/operations/troubleshooting.html">Troubleshooting</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Security</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/security/authentication.html">Authentication</a>
</li>
<li class="nav-item depth-1">
<a href="/security/permissions.html">Permissions</a>
</li>
<li class="nav-item depth-1">
<a href="/security/ssl-certificates.html">SSL Certificates</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Testing</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/testing/testing-strategy.html">Strategy</a>
</li>
<li class="nav-item depth-1">
<a href="/testing/strategies.html">Strategies</a>
</li>
<li class="nav-item depth-1">
<a href="/testing/test-cases.html">Test Cases</a>
</li>
<li class="nav-item depth-1">
<a href="/testing/validation.html">Validation</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Integration</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/integration/onvif-protocol.html">ONVIF Protocol</a>
</li>
<li class="nav-item depth-1">
<a href="/integration/third-party.html">Third Party</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Reference</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/reference/glossary.html">Glossary</a>
</li>
<li class="nav-item depth-1">
<a href="/reference/requirements.html">Requirements</a>
</li>
<li class="nav-item depth-1">
<a href="/reference/state-observables.html">State Observables</a>
</li>
</ul>
</li>
<li class="nav-folder depth-0">
<span class="folder-title">Releases</span>
<ul class="nav-submenu">
<li class="nav-item depth-1">
<a href="/releases/CHANGELOG.html">Changelog</a>
</li>
</ul>
</li>
<li class="nav-item depth-0">
<a href="/glossary.html">Glossary</a>
</li>
                </ul>
            </nav>
        </aside>
        
        <main class="content">
            <div class="content-wrapper">
                <h1 id="camera-pipeline-architecture">Camera Pipeline Architecture</h1>
<p><strong>V4L2 and GStreamer integration for high-performance video capture and streaming.</strong></p>
<h2 id="overview">Overview</h2>
<p>The RotoClear camera pipeline provides real-time video capture, processing, and streaming for industrial/medical imaging applications using V4L2 drivers and GStreamer multimedia framework.</p>
<div class="mermaid">
graph LR
    A[Camera Hardware] --> B[V4L2 Driver]
    B --> C[GStreamer Pipeline]
    C --> D[JPEG Encoder]
    C --> E[H.264 Encoder]
    C --> F[AVI Muxer]
    D --> G[WebSocket Stream]
    E --> H[RTSP Stream]
    F --> I[File Storage]
</div>

<h2 id="hardware-interface">Hardware Interface</h2>
<h3 id="v4l2-integration">V4L2 Integration</h3>
<p>Located in <code>src/camserver/</code>:</p>
<ul>
<li><strong>Device Detection</strong>: <code>v4l2_dev_interface.c</code> - Camera enumeration and capability detection</li>
<li><strong>Control Interface</strong>: <code>v4l2_m2m_dev.c</code> - Memory-to-memory device operations  </li>
<li><strong>UDev Monitoring</strong>: <code>udev_monitor.c</code> - Hot-plug device detection</li>
<li><strong>Hardware Controls</strong>: Exposure, gain, white balance, focus controls</li>
</ul>
<h3 id="camera-types-supported">Camera Types Supported</h3>
<ul>
<li><strong>USB Cameras</strong>: UVC-compatible devices via <code>/dev/video*</code></li>
<li><strong>CSI Cameras</strong>: Direct camera sensor interface</li>
<li><strong>IP Cameras</strong>: ONVIF-compatible network cameras</li>
<li><strong>Multiple Heads</strong>: Simultaneous multi-camera operation</li>
</ul>
<h3 id="device-capabilities">Device Capabilities</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// From v4l2_dev_interface.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">camera_caps</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">device_path</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">capabilities</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_fmtdesc</span><span class="w"> </span><span class="n">formats</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_frmsizeenum</span><span class="w"> </span><span class="n">frame_sizes</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_frmivalenum</span><span class="w"> </span><span class="n">frame_intervals</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="gstreamer-pipeline">GStreamer Pipeline</h2>
<h3 id="pipeline-architecture">Pipeline Architecture</h3>
<p>The system uses dynamic GStreamer pipelines built in <code>src/camserver/streamer.nim</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Main capture pipeline</span>
v4l2src<span class="w"> </span><span class="nv">device</span><span class="o">=</span>/dev/video0<span class="w"> </span>!<span class="w"> </span>
<span class="w">    </span>video/x-raw,width<span class="o">=</span><span class="m">1920</span>,height<span class="o">=</span><span class="m">1080</span>,framerate<span class="o">=</span><span class="m">30</span>/1<span class="w"> </span>!
<span class="w">    </span>tee<span class="w"> </span><span class="nv">name</span><span class="o">=</span>t

<span class="c1"># JPEG encoding branch  </span>
t.<span class="w"> </span>!<span class="w"> </span>queue<span class="w"> </span>!<span class="w"> </span>jpegenc<span class="w"> </span><span class="nv">quality</span><span class="o">=</span><span class="m">85</span><span class="w"> </span>!<span class="w"> </span>
<span class="w">    </span>appsink<span class="w"> </span><span class="nv">name</span><span class="o">=</span>jpeg_sink

<span class="c1"># H.264 streaming branch</span>
t.<span class="w"> </span>!<span class="w"> </span>queue<span class="w"> </span>!<span class="w"> </span>x264enc<span class="w"> </span><span class="nv">bitrate</span><span class="o">=</span><span class="m">2000</span><span class="w"> </span><span class="nv">tune</span><span class="o">=</span>zerolatency<span class="w"> </span>!
<span class="w">    </span>rtph264pay<span class="w"> </span>!<span class="w"> </span>udpsink<span class="w"> </span><span class="nv">host</span><span class="o">=</span><span class="m">224</span>.1.1.1<span class="w"> </span><span class="nv">port</span><span class="o">=</span><span class="m">5004</span>

<span class="c1"># Recording branch</span>
t.<span class="w"> </span>!<span class="w"> </span>queue<span class="w"> </span>!<span class="w"> </span>x264enc<span class="w"> </span><span class="nv">bitrate</span><span class="o">=</span><span class="m">4000</span><span class="w"> </span>!
<span class="w">    </span>avimux<span class="w"> </span>!<span class="w"> </span>filesink<span class="w"> </span><span class="nv">location</span><span class="o">=</span>recording.avi
</code></pre></div>

<h3 id="gstreamer-components">GStreamer Components</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Purpose</th>
<th>Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>v4l2src</code></td>
<td>Video capture from V4L2 device</td>
<td>Device path, format, resolution</td>
</tr>
<tr>
<td><code>jpegenc</code></td>
<td>JPEG compression for snapshots</td>
<td>Quality level, timestamp overlay</td>
</tr>
<tr>
<td><code>x264enc</code></td>
<td>H.264 video encoding</td>
<td>Bitrate, tune parameters, GOP size</td>
</tr>
<tr>
<td><code>rtph264pay</code></td>
<td>RTP packetization</td>
<td>MTU size, payload type</td>
</tr>
<tr>
<td><code>avimux</code></td>
<td>AVI container multiplexing</td>
<td>Metadata embedding</td>
</tr>
</tbody>
</table>
<h3 id="timestamp-integration">Timestamp Integration</h3>
<p>Custom timestamp overlays implemented in <code>timestamp_bitmaps.h</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Timestamp bitmap rendering</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">bitmap_data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">timestamp_us</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">timestamp_overlay_t</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">render_timestamp</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">frame_data</span><span class="p">,</span><span class="w"> </span><span class="n">timestamp_overlay_t</span><span class="o">*</span><span class="w"> </span><span class="n">overlay</span><span class="p">);</span>
</code></pre></div>

<h2 id="image-processing">Image Processing</h2>
<h3 id="jpeg-encoding">JPEG Encoding</h3>
<p>High-performance JPEG encoding in <code>jpg_encoder.c</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Hardware-accelerated JPEG encoding</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">encode_jpeg_frame</span><span class="p">(</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">yuv_data</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">jpeg_buffer</span><span class="p">,</span>
<span class="w">    </span><span class="kt">size_t</span><span class="o">*</span><span class="w"> </span><span class="n">jpeg_size</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">quality</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="format-support">Format Support</h3>
<ul>
<li><strong>Input Formats</strong>: YUV420, YUV422, RGB24, MJPEG</li>
<li><strong>Output Formats</strong>: JPEG, H.264, AVI</li>
<li><strong>Resolutions</strong>: 640x480 to 3840x2160 (4K)</li>
<li><strong>Frame Rates</strong>: 1-30 FPS configurable</li>
</ul>
<h3 id="nv12-rendering">NV12 Rendering</h3>
<p>Optimized NV12 format handling in <code>nv12_render.h</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// NV12 to RGB conversion with SIMD optimization</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">nv12_to_rgb_simd</span><span class="p">(</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">nv12_data</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">rgb_data</span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span>
<span class="p">);</span>
</code></pre></div>

<h2 id="streaming-protocols">Streaming Protocols</h2>
<h3 id="rtsp-server">RTSP Server</h3>
<p>Standards-compliant RTSP server with RTP streaming:</p>
<ul>
<li><strong>Port</strong>: 8554 (configurable)</li>
<li><strong>Transport</strong>: RTP/UDP and RTP/TCP</li>
<li><strong>Codecs</strong>: H.264 baseline profile</li>
<li><strong>Authentication</strong>: Optional basic authentication</li>
</ul>
<h3 id="websocket-streaming">WebSocket Streaming</h3>
<p>Real-time JPEG frames over WebSocket:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># From src/camserver/cam.nim</span>
<span class="k">proc</span><span class="w"> </span><span class="nf">streamJpegFrame</span><span class="o">*</span><span class="p">():</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">byte</span><span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">captureV4L2Frame</span><span class="p">()</span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encodeJpegWithTimestamp</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">jpegQuality</span><span class="p">)</span>

<span class="k">proc</span><span class="w"> </span><span class="nf">broadcastFrame</span><span class="o">*</span><span class="p">()</span><span class="w"> </span><span class="sx">{.async.}</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="n">frameData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">streamJpegFrame</span><span class="p">()</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">streamingClients</span><span class="p">:</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">sendBinary</span><span class="p">(</span><span class="n">frameData</span><span class="p">)</span>
</code></pre></div>

<h2 id="recording-system">Recording System</h2>
<h3 id="video-recording">Video Recording</h3>
<p>AVI recording with configurable parameters:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># Recording configuration</span>
<span class="k">type</span><span class="w"> </span><span class="n">RecordingConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">object</span>
<span class="w">  </span><span class="n">filename</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span>
<span class="w">  </span><span class="n">resolution</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span><span class="w">  </span>
<span class="w">  </span><span class="n">framerate</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span>
<span class="w">  </span><span class="n">bitrate</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span>
<span class="w">  </span><span class="n">codec</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span><span class="w">  </span><span class="c"># &quot;h264&quot;, &quot;mjpeg&quot;</span>
<span class="w">  </span><span class="n">duration</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span><span class="w">  </span><span class="c"># seconds, 0 = unlimited</span>
</code></pre></div>

<h3 id="snapshot-capture">Snapshot Capture</h3>
<p>High-resolution image capture:</p>
<div class="codehilite"><pre><span></span><code><span class="k">proc</span><span class="w"> </span><span class="nf">takeSnapshot</span><span class="o">*</span><span class="p">(</span><span class="n">quality</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">95</span><span class="p">):</span><span class="w"> </span><span class="nb">seq</span><span class="o">[</span><span class="n">byte</span><span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="c"># Capture full-resolution frame</span>
<span class="w">  </span><span class="k">let</span><span class="w"> </span><span class="n">fullFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">captureFullResFrame</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Add timestamp overlay</span>
<span class="w">  </span><span class="n">addTimestampOverlay</span><span class="p">(</span><span class="n">fullFrame</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Encode as high-quality JPEG</span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encodeJpeg</span><span class="p">(</span><span class="n">fullFrame</span><span class="p">,</span><span class="w"> </span><span class="n">quality</span><span class="p">)</span>
</code></pre></div>

<h2 id="performance-optimization">Performance Optimization</h2>
<h3 id="hardware-acceleration">Hardware Acceleration</h3>
<ul>
<li><strong>V4L2 M2M</strong>: Memory-to-memory hardware encoding</li>
<li><strong>GPU Acceleration</strong>: VAAPI/NVENC support where available</li>
<li><strong>SIMD Instructions</strong>: Optimized color space conversion</li>
<li><strong>Zero-copy</strong>: Direct memory access to reduce copies</li>
</ul>
<h3 id="memory-management">Memory Management</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Ring buffer for frame management</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="n">RING_BUFFER_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">write_index</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">read_index</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">frame_size</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">frame_ring_buffer_t</span><span class="p">;</span>
</code></pre></div>

<h3 id="threading-model">Threading Model</h3>
<ul>
<li><strong>Capture Thread</strong>: V4L2 frame acquisition</li>
<li><strong>Encoding Thread</strong>: JPEG/H.264 encoding</li>
<li><strong>Streaming Thread</strong>: Network transmission</li>
<li><strong>Main Thread</strong>: Control and coordination</li>
</ul>
<h2 id="camera-control">Camera Control</h2>
<h3 id="v4l2-controls">V4L2 Controls</h3>
<p>Direct hardware control via V4L2 interface:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Camera control implementation</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">set_camera_control</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">device_fd</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">control_id</span><span class="p">,</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_control</span><span class="w"> </span><span class="n">ctrl</span><span class="p">;</span>
<span class="w">    </span><span class="n">ctrl</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">control_id</span><span class="p">;</span>
<span class="w">    </span><span class="n">ctrl</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ioctl</span><span class="p">(</span><span class="n">device_fd</span><span class="p">,</span><span class="w"> </span><span class="n">VIDIOC_S_CTRL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="supported-controls">Supported Controls</h3>
<ul>
<li><strong>V4L2_CID_EXPOSURE</strong>: Exposure time control</li>
<li><strong>V4L2_CID_GAIN</strong>: Sensor gain/ISO</li>
<li><strong>V4L2_CID_BRIGHTNESS</strong>: Image brightness</li>
<li><strong>V4L2_CID_CONTRAST</strong>: Image contrast</li>
<li><strong>V4L2_CID_SATURATION</strong>: Color saturation</li>
<li><strong>V4L2_CID_WHITE_BALANCE_TEMPERATURE</strong>: White balance</li>
</ul>
<h3 id="state-integration">State Integration</h3>
<p>Camera controls are integrated with the observable state system:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># Camera control state observers</span>
<span class="n">exposureState</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">proc</span><span class="p">(</span><span class="n">oldVal</span><span class="p">,</span><span class="w"> </span><span class="n">newVal</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">setCameraExposure</span><span class="p">(</span><span class="n">newVal</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">gainState</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">proc</span><span class="p">(</span><span class="n">oldVal</span><span class="p">,</span><span class="w"> </span><span class="n">newVal</span><span class="p">:</span><span class="w"> </span><span class="nb">float</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">setCameraGain</span><span class="p">(</span><span class="nb">int32</span><span class="p">(</span><span class="n">newVal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="pipeline-management">Pipeline Management</h2>
<h3 id="dynamic-reconfiguration">Dynamic Reconfiguration</h3>
<p>The pipeline supports runtime reconfiguration without stopping:</p>
<div class="codehilite"><pre><span></span><code><span class="k">proc</span><span class="w"> </span><span class="nf">reconfigurePipeline</span><span class="o">*</span><span class="p">(</span><span class="n">newResolution</span><span class="p">:</span><span class="w"> </span><span class="nb">string</span><span class="p">,</span><span class="w"> </span><span class="n">newFramerate</span><span class="p">:</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="c"># Pause current pipeline</span>
<span class="w">  </span><span class="n">pauseGStreamerPipeline</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Update pipeline elements</span>
<span class="w">  </span><span class="n">updateCameraCaps</span><span class="p">(</span><span class="n">newResolution</span><span class="p">,</span><span class="w"> </span><span class="n">newFramerate</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Resume with new settings</span>
<span class="w">  </span><span class="n">resumeGStreamerPipeline</span><span class="p">()</span>
</code></pre></div>

<h3 id="error-recovery">Error Recovery</h3>
<p>Robust error handling and automatic recovery:</p>
<div class="codehilite"><pre><span></span><code><span class="k">proc</span><span class="w"> </span><span class="nf">handlePipelineError</span><span class="o">*</span><span class="p">(</span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="n">GStreamerError</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="n">code</span><span class="p">:</span>
<span class="w">  </span><span class="k">of</span><span class="w"> </span><span class="nl">GST_STREAM_ERROR_DEVICE_BUSY</span><span class="o">:</span>
<span class="w">    </span><span class="c"># Retry after delay</span>
<span class="w">    </span><span class="n">scheduleRetry</span><span class="p">(</span><span class="n">reconnectCamera</span><span class="p">,</span><span class="w"> </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">)</span>
<span class="w">  </span><span class="k">of</span><span class="w"> </span><span class="nl">GST_RESOURCE_ERROR_OPEN_READ</span><span class="o">:</span>
<span class="w">    </span><span class="c"># Switch to backup camera</span>
<span class="w">    </span><span class="n">switchToBackupCamera</span><span class="p">()</span>
<span class="w">  </span><span class="k">else</span><span class="p">:</span>
<span class="w">    </span><span class="c"># Full pipeline restart</span>
<span class="w">    </span><span class="n">restartCameraPipeline</span><span class="p">()</span>
</code></pre></div>

<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="common-issues">Common Issues</h3>
<p><strong>Camera Not Detected</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check V4L2 devices</span>
v4l2-ctl<span class="w"> </span>--list-devices

<span class="c1"># Verify permissions</span>
ls<span class="w"> </span>-l<span class="w"> </span>/dev/video*

<span class="c1"># Test basic capture</span>
v4l2-ctl<span class="w"> </span>--device<span class="o">=</span>/dev/video0<span class="w"> </span>--stream-mmap<span class="w"> </span>--stream-count<span class="o">=</span><span class="m">1</span>
</code></pre></div>

<p><strong>Pipeline Errors</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Enable GStreamer debug</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">GST_DEBUG</span><span class="o">=</span><span class="m">3</span>
./rotordream

<span class="c1"># Check pipeline state</span>
gst-inspect-1.0<span class="w"> </span>v4l2src
</code></pre></div>

<p><strong>Performance Issues</strong><br />
- Monitor CPU usage during encoding<br />
- Check memory bandwidth utilization<br />
- Verify USB bus speed for USB cameras<br />
- Consider hardware encoding acceleration</p>
<h3 id="debug-tools">Debug Tools</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># V4L2 debugging</span>
v4l2-ctl<span class="w"> </span>--device<span class="o">=</span>/dev/video0<span class="w"> </span>--all

<span class="c1"># GStreamer pipeline testing</span>
gst-launch-1.0<span class="w"> </span>v4l2src<span class="w"> </span><span class="nv">device</span><span class="o">=</span>/dev/video0<span class="w"> </span>!<span class="w"> </span>jpegenc<span class="w"> </span>!<span class="w"> </span>filesink<span class="w"> </span><span class="nv">location</span><span class="o">=</span>test.jpg

<span class="c1"># Frame rate monitoring</span>
gst-launch-1.0<span class="w"> </span>v4l2src<span class="w"> </span>!<span class="w"> </span>fpsdisplaysink
</code></pre></div>

<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../camera/hardware-interface.md">Hardware Interface Details</a></li>
<li><a href="../camera/streaming.md">Streaming Configuration</a></li>
<li><a href="../camera/image-processing.md">Image Processing</a></li>
<li><a href="overview.md">Architecture Overview</a></li>
</ul>
<hr />
<p><em>Camera pipeline documentation derived from <code>src/camserver/</code> C code and Nim integration</em></p>
            </div>
            <footer class="content-footer">
                <p>Copyright © 2025 Rotoclear</p>
            </footer>
        </main>
        
        <button class="mobile-menu-toggle" id="menuToggle" aria-label="Toggle menu">☰</button>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'Inter, sans-serif'
        });
        
        // Syntax highlighting
        hljs.highlightAll();
        
        // Mobile menu toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');
        
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target) &&
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
        
        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
    </script>
</body>
</html>